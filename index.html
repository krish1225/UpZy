<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="UpZy - Track steps and calories with friends">
    <title>UpZy</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Logo Header -->
    <div class="logo-header">
        <img src="Images/UpZyV3.png" alt="UpZy Logo" class="logo-img">
        <span class="logo-text">UpZy</span>
    </div>

    <!-- Main Container -->
    <div class="container main-content">
        
        <!-- Home Page -->
        <div id="page-home" class="page active">
            <div id="hero-section" class="hero">
                <h1>Welcome to UpZy</h1>
                <p>Track your steps and compete with friends</p>
                <div class="hero-buttons">
                    <button class="btn btn-primary" onclick="showPage('login-signup')">Join Challenge</button>
                </div>
            </div>

            <!-- Leaderboard Section (shown for logged-in users) -->
            <div id="leaderboard-section" style="display:none; padding: 2rem;">
                <div class="leaderboard-tabs">
                    <button class="tab-btn active" data-tab="daily">Daily Winner</button>
                    <button class="tab-btn" data-tab="weekly">Weekly Ranking</button>
                    <button class="tab-btn" data-tab="overall">Overall</button>
                </div>

                <div id="tab-daily" class="tab-content active">
                    <h3>Today's Top Performers</h3>
                    <div id="dailyLeaderboard" class="leaderboard-list"></div>
                </div>

                <div id="tab-weekly" class="tab-content" style="display:none;">
                    <h3>This Week's Ranking</h3>
                    <div id="weeklyLeaderboard" class="leaderboard-list"></div>
                </div>

                <div id="tab-overall" class="tab-content" style="display:none;">
                    <h3>Overall Challenge Ranking</h3>
                    <div id="overallLeaderboard" class="leaderboard-list"></div>
                </div>
            </div>
        </div>

        <!-- Login/Signup Page -->
        <div id="page-login-signup" class="page" style="display:none;">
            <div class="form-container">
                <!-- Login Form -->
                <form id="loginForm">
                    <h2>Join UpZy</h2>
                    <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">Login to your account</p>
                    
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn btn-primary">Continue</button>
                    <button type="button" class="btn btn-secondary" onclick="showPage('home')">Back</button>
                    
                    <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary);">
                        <a href="#" onclick="switchAuthTab('forgot'); return false;" style="color: var(--primary-color); font-weight: 600; font-size: 14px;">Forgot Password?</a>
                    </p>
                    
                    <p style="text-align: center; margin-top: 2rem; color: var(--text-secondary);">
                        Don't have an account? 
                        <a href="#" onclick="switchAuthTab('signup'); return false;" style="color: var(--primary-color); font-weight: 600;">Sign Up</a>
                    </p>
                </form>
                <!-- Signup Form -->
                <form id="signupForm" style="display:none;">
                    <h2>Create Account</h2>
                    <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">Sign up to join the challenge</p>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="signupEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Invite Code</label>
                        <input type="text" id="signupInviteCode" required placeholder="Enter your invite code">
                    </div>
                    <div class="form-group">
                        <label>Create Password</label>
                        <input type="password" id="signupPassword" required placeholder="Enter a strong password" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" required placeholder="Confirm your password" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                    <button type="button" class="btn btn-secondary" onclick="showPage('home')">Back</button>
                    
                    <p style="text-align: center; margin-top: 2rem; color: var(--text-secondary);">
                        Already have an account? 
                        <a href="#" onclick="switchAuthTab('login'); return false;" style="color: var(--primary-color); font-weight: 600;">Login</a>
                    </p>
                </form>

                <!-- Forgot Password Form -->
                <form id="forgotPasswordForm" style="display:none;">
                    <h2>Reset Password</h2>
                    <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">Enter your email to reset your password</p>
                    
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="forgotEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="forgotPassword" required placeholder="Enter new password" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="forgotPasswordConfirm" required placeholder="Confirm new password" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Reset Password</button>
                    <button type="button" class="btn btn-secondary" onclick="showPage('home')">Back</button>
                    
                    <p style="text-align: center; margin-top: 2rem; color: var(--text-secondary);">
                        Remember your password? 
                        <a href="#" onclick="switchAuthTab('login'); return false;" style="color: var(--primary-color); font-weight: 600;">Login</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- Old duplicate removed -->

        <!-- Join Challenge Page (Invite Code) -->
        <div id="page-join-with-code" class="page" style="display:none;">
            <div class="form-container">
                <h2>Enter Invite Code</h2>
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">Enter your invite code to complete joining</p>
                
                <form id="joinWithCodeForm">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="joinCodeEmail" readonly placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Invite Code</label>
                        <input type="text" id="joinCodeInput" required placeholder="Enter your invite code">
                    </div>
                    <button type="submit" class="btn btn-primary">Join Challenge</button>
                    <button type="button" class="btn btn-secondary" onclick="showPage('home')">Back</button>
                </form>
            </div>
        </div>

        <!-- Admin Login Page -->
        <div id="page-admin-login" class="page" style="display:none;">
            <div class="form-container">
                <h2>Admin Access</h2>
                <form id="adminLoginForm">
                    <div class="form-group">
                        <label>Admin Email</label>
                        <input type="email" id="adminEmail" required placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label>Admin Password</label>
                        <input type="password" id="adminPassword" required placeholder="Enter admin password">
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <button type="button" class="btn btn-secondary" onclick="showPage('home')">Back</button>
                </form>
            </div>
        </div>

        <!-- Setup Password Page -->
        <div id="page-setup-password" class="page" style="display:none;">
            <div class="form-container">
                <h2>Set Up Your Password</h2>
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">Create a password to secure your account</p>
                <form id="setupPasswordForm">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="setupEmail" readonly placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Create Password</label>
                        <input type="password" id="setupPassword" required placeholder="Enter a strong password" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="setupPasswordConfirm" required placeholder="Confirm your password" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Continue</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page" style="display:none;">
            <div class="dashboard-header">
                <h2>Welcome, <span id="userNameDisplay">User</span>!</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSteps">0</div>
                    <div class="stat-label">Total Steps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">Total Calories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentRank">-</div>
                    <div class="stat-label">Current Rank</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">Day Streak ðŸ”¥</div>
                </div>
            </div>

            <div class="submission-card">
                <h3>Submit Today's Activity</h3>
                <form id="submitForm">
                    <div class="form-group">
                        <label>Steps Today</label>
                        <input type="number" id="stepsInput" required min="0" placeholder="Enter steps">
                    </div>
                    <div class="form-group">
                        <label>Calories Burned</label>
                        <input type="number" id="caloriesInput" required min="0" placeholder="Enter calories">
                    </div>
                    <div class="form-group">
                        <label>Date (default: today)</label>
                        <input type="date" id="dateInput">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Submit</button>
                </form>
            </div>

            <!-- History Table -->
            <div style="margin-top: 3rem;">
                <h3>My Daily History</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                    <thead>
                        <tr style="background-color: var(--light-bg); border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Date</th>
                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Steps</th>
                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Calories</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="3" style="padding: 2rem; text-align: center; color: #999;">No history data yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div id="page-leaderboard" class="page" style="display:none;">
            <h2>Leaderboard</h2>
            <div class="leaderboard-tabs">
                <button class="tab-btn active" data-tab="daily">Daily Winner</button>
                <button class="tab-btn" data-tab="weekly">Weekly Ranking</button>
                <button class="tab-btn" data-tab="overall">Overall</button>
            </div>

            <!-- Challenge Selector Dropdown (for logged-in users) -->
            <div id="challengeSelector" style="margin-bottom: 1.5rem; display: none;">
                <label for="leaderboardChallengeSelect" style="margin-right: 1rem; font-weight: 500;">Select Challenge:</label>
                <select id="leaderboardChallengeSelect" onchange="updateChallengeLeaderboard(this.value)" style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; min-width: 250px;">
                    <option value="">-- All Challenges --</option>
                </select>
            </div>

            <div id="tab-daily" class="tab-content active">
                <h3>Today's Top Performers</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-top: 0; text-align: center;">Steps Progress</h4>
                        <canvas id="dailyStepsChart"></canvas>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-top: 0; text-align: center;">Calories Progress</h4>
                        <canvas id="dailyCaloriesChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-weekly" class="tab-content" style="display:none;">
                <h3>This Week's Ranking</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-top: 0; text-align: center;">Steps Progress</h4>
                        <canvas id="weeklyStepsChart"></canvas>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-top: 0; text-align: center;">Calories Progress</h4>
                        <canvas id="weeklyCaloriesChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-overall" class="tab-content" style="display:none;">
                <h3>Overall Challenge Ranking</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-top: 0; text-align: center;">Steps Progress</h4>
                        <canvas id="overallStepsChart"></canvas>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-top: 0; text-align: center;">Calories Progress</h4>
                        <canvas id="overallCaloriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-admin" class="page" style="display:none;">
            <div class="admin-panel">
                <h2>Admin Panel</h2>
                
                <!-- Admin Tabs -->
                <div class="admin-tabs">
                    <button class="admin-tab-btn active" data-admin-tab="challenges">Challenges</button>
                    <button class="admin-tab-btn" data-admin-tab="participants">Participants</button>
                    <button class="admin-tab-btn" data-admin-tab="invites">Invites</button>
                </div>

                <!-- Challenges Tab -->
                <div id="admin-tab-challenges" class="admin-tab-content active">
                    <div style="margin-bottom: 1.5rem;">
                        <button class="btn btn-primary" onclick="openCreateChallengeModal()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">+ Create New Challenge</button>
                    </div>

                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="padding: 1rem; background: var(--light-bg); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);" id="totalChallengesCount">0</div>
                            <div style="color: var(--text-secondary);">Total Challenges</div>
                        </div>
                        <div style="padding: 1rem; background: var(--light-bg); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="totalUsersInChallengesCount">0</div>
                            <div style="color: var(--text-secondary);">Total Users Enrolled</div>
                        </div>
                    </div>

                    <!-- Challenges Table -->
                    <div class="challenges-table-section">
                        <h3>All Challenges</h3>
                        <table class="challenges-table">
                            <thead>
                                <tr>
                                    <th>Challenge Name</th>
                                    <th>Duration</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Enrolled Users</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="challengesTableBody">
                                <tr><td colspan="7" style="text-align: center; color: #999;">No challenges created yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Participants Tab -->
                <div id="admin-tab-participants" class="admin-tab-content" style="display:none;">
                    <h3>All Participants</h3>
                    <div id="participantsList" class="participants-list"></div>
                </div>

                <!-- Invites Tab -->
                <div id="admin-tab-invites" class="admin-tab-content" style="display:none;">
                    <h3>Generate Invite Codes</h3>
                    <form id="inviteForm">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="emailForInvite" required placeholder="friend@example.com">
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Invite</button>
                    </form>
                    <div id="generatedInvite" style="display:none; margin-top: 1rem;">
                        <p>Invite Code: <strong id="inviteCodeDisplay"></strong></p>
                        <p>Share this code with: <strong id="emailDisplay"></strong></p>
                        <button onclick="copyInvite()" class="btn btn-secondary">Copy</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Assign Users to Challenge Modal -->
    <div id="assignUsersModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Assign Users to Challenge</h2>
                <button class="modal-close" onclick="closeAssignUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Challenge: <strong id="assignChallengeNameDisplay"></strong></label>
                </div>
                <div class="form-group">
                    <label>Select Users to Add:</label>
                    <div id="usersList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAssignUsersModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAssignUsers()">Assign Selected Users</button>
            </div>
        </div>
    </div>

    <!-- Create Challenge Modal -->
    <div id="createChallengeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Create New Challenge</h2>
                <button class="modal-close" onclick="closeCreateChallengeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createChallengeForm">
                    <div class="form-group">
                        <label>Challenge Name</label>
                        <input type="text" id="challengeName" placeholder="e.g., Steps Challenge 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Challenge Duration (days)</label>
                        <input type="number" id="newChallengeDuration" value="30" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="newChallengeStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="challengeDescription" placeholder="Challenge description..." rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateChallengeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('createChallengeForm').dispatchEvent(new Event('submit'))">Create Challenge</button>
            </div>
        </div>
    </div>

    <!-- Edit Challenge Modal -->
    <div id="editChallengeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Challenge</h2>
                <button class="modal-close" onclick="closeEditChallengeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editChallengeForm">
                    <div class="form-group">
                        <label>Challenge Name</label>
                        <input type="text" id="editChallengeName" placeholder="e.g., Steps Challenge 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Challenge Duration (days)</label>
                        <input type="number" id="editChallengeDuration" value="30" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="editChallengeStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editChallengeDescription" placeholder="Challenge description..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editChallengeStatus" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditChallengeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedChallenge()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- View Challenge Users Modal -->
    <div id="viewChallengeUsersModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Users in Challenge: <span id="viewChallengeName"></span></h2>
                <button class="modal-close" onclick="closeViewUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Users will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeViewUsersModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Menu -->
    <div class="bottom-nav">
        <button class="nav-item" onclick="showPage('home')" title="Home">
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" id="leaderboardNav" onclick="showPage('leaderboard')" style="display:none;" title="Leaderboard">
            <span class="nav-label">Leaderboard</span>
        </button>
        <button class="nav-item" id="adminNav" onclick="showPage('admin')" style="display:none;" title="Admin">
            <span class="nav-label">Admin</span>
        </button>
        <button class="nav-item" id="logoutNavBtn" onclick="logout()" style="display:none;" title="Logout">
            <span class="nav-label">Logout</span>
        </button>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification" style="display: none;"></div>

    <script src="js/supabase-client.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/script.js"></script>
</body>
</html>
